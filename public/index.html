<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Table Generator with Download</title>
    <style>
        table {
            border-collapse: collapse;
            margin: 10px;
        }
        th, td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
        }
    </style>
</head>
<body>

    <h2>Random table ID</h2>
    <label for="primaryTableIdInput">Primary Table ID:</label>
    <input type="number" id="primaryTableIdInput" name="primaryTableIdInput" min="1" value="1">

    <h2>Dynamic Table Generator</h2>

    <label for="initialRows">Number of Rows:</label>
    <input type="number" id="initialRows" name="initialRows" min="1" max="10" value="3">
    <label for="initialCols">Number of Columns:</label>
    <input type="number" id="initialCols" name="initialCols" min="1" max="30" value="10">
    <button onclick="generateInitialTable()">Create Initial Table</button><br><br>

    <div id="initialTableContainer"></div>

    <h3>Random Secondary Tables Generator</h3>
    <label for="randomRows">Random Table Rows:</label>
    <input type="number" id="randomRows" name="randomRows" min="1" value="3">
    <label for="randomCols">Random Table Columns:</label>
    <input type="number" id="randomCols" name="randomCols" min="1" value="3">
    <label for="numTables">Number of Random Tables:</label>
    <input type="number" id="numTables" name="numTables" min="1" value="5">
    <button onclick="generateRandomTables()">Generate Random Tables</button>
    <button onclick="downloadPDF()">Download PDF</button>
    <button onclick="downloadDoc()">Download DOC</button>
    <button onclick="saveSecondaryTables()">Save Secondary Tables</button>
    <button onclick="retrieveSecondaryTables()">Retrieve Secondary Tables</button>

    <h3>Randomly Generated Tables</h3>
    <div id="randomTablesContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.0.1/docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
        let initialTable = [];
        let randomTablesData = [];

        // Function to generate the initial table with checkboxes for row removal
        function generateInitialTable() {
            const numRows = document.getElementById('initialRows').value;
            const numCols = document.getElementById('initialCols').value;
            initialTable = [];

            let tableContainer = document.getElementById('initialTableContainer');
            tableContainer.innerHTML = ''; // Clear previous table

            let table = document.createElement('table');

            // Generate the header row with column checkboxes
            let headerRow = document.createElement('tr');
            let headerCheckboxCell = document.createElement('td');
            headerRow.appendChild(headerCheckboxCell); // Empty cell for row checkboxes

            for (let j = 0; j < numCols; j++) {
                let colCheckboxCell = document.createElement('td');
                let colCheckbox = document.createElement('input');
                colCheckbox.type = 'checkbox';
                colCheckbox.id = `removeCol${j}`;
                colCheckboxCell.appendChild(colCheckbox);
                headerRow.appendChild(colCheckboxCell);
            }
            table.appendChild(headerRow);

            // Generate the table with input fields and row checkboxes
            for (let i = 0; i < numRows; i++) {
                let row = [];
                let tableRow = document.createElement('tr');

                // Row checkbox for removal
                let rowCheckboxCell = document.createElement('td');
                let rowCheckbox = document.createElement('input');
                rowCheckbox.type = 'checkbox';
                rowCheckbox.id = `removeRow${i}`;
                rowCheckboxCell.appendChild(rowCheckbox);
                tableRow.appendChild(rowCheckboxCell);

                for (let j = 0; j < numCols; j++) {
                    let cell = document.createElement('td');
                    let input = document.createElement('input');
                    input.type = 'text';
                    input.id = `R${i}C${j}`; // Unique ID for each cell
                    input.placeholder = `R${i+1}C${j+1}`;
                    row.push(input.id);
                    cell.appendChild(input);
                    tableRow.appendChild(cell);
                }
                initialTable.push(row);
                table.appendChild(tableRow);
            }
            tableContainer.appendChild(table);
        }

        // Function to get the values from the initial table
        function getInitialTableValues() {
            let tableValues = [];
            for (let i = 0; i < initialTable.length; i++) {
                if (document.getElementById(`removeRow${i}`).checked) {
                    continue; // Skip excluded rows
                }
                let rowValues = [];
                for (let j = 0; j < initialTable[i].length; j++) {
                    if (document.getElementById(`removeCol${j}`).checked) {
                        continue; // Skip excluded columns
                    }
                    let cellValue = document.getElementById(initialTable[i][j]).value || initialTable[i][j];
                    rowValues.push(cellValue);
                }
                tableValues.push(rowValues);
            }
            return tableValues;
        }

        // Function to generate random tables with random rows but the same columns
        function generateRandomTables() {
            const randomRows = parseInt(document.getElementById('randomRows').value);
            const numTables = parseInt(document.getElementById('numTables').value);
            const initialTableValues = getInitialTableValues();  // Get the values from the initial table

            let randomTablesContainer = document.getElementById('randomTablesContainer');
            randomTablesContainer.innerHTML = ''; // Clear previous tables
            randomTablesData = []; // Reset random tables data

            for (let i = 0; i < numTables; i++) {
                let selectedRows = getRandomSelection(initialTableValues.length, randomRows);  // Random rows
                let randomTable = [];

                for (let row of selectedRows) {
                    randomTable.push([...initialTableValues[row]]);  // Keep the columns intact
                }

                randomTablesData.push(randomTable);  // Store the table data
                displayTable(randomTable, randomTablesContainer);  // Display the table
            }
        }

        // Helper function to generate unique random row indices
        function getRandomSelection(total, count) {
            let selected = [];
            while (selected.length < count) {
                let randomIndex = Math.floor(Math.random() * total);
                if (!selected.includes(randomIndex)) {
                    selected.push(randomIndex);
                }
            }
            return selected;
        }

        // Helper function to display the generated tables
        function displayTable(tableData, container) {
            let table = document.createElement('table');
            for (let row of tableData) {
                let tableRow = document.createElement('tr');
                for (let cell of row) {
                    let td = document.createElement('td');
                    td.innerHTML = cell;
                    tableRow.appendChild(td);
                }
                table.appendChild(tableRow);
            }
            container.appendChild(table);
        }

        // Function to download the random tables as a PDF file with tables filling the page
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let currentY = 10; // Start Y position

            randomTablesData.forEach((table, index) => {
                // Add a title for each random table
                doc.text(`Random Table ${index + 1}`, 10, currentY);
                doc.autoTable({
                    startY: currentY + 10,  // Position below the title
                    body: table  // Pass the table data
                });

                currentY = doc.lastAutoTable.finalY + 20;  // Adjust Y position based on table height

                if (currentY >= 280) {  // If the Y position exceeds the page height
                    doc.addPage();  // Add a new page
                    currentY = 10;  // Reset Y position for the new page
                }
            });

            doc.save('random_tables.pdf');
        }

        // Function to download the random tables as a DOC file
        function downloadDoc() {
            const doc = new docx.Document({
                sections: [
                    {
                        properties: {},
                        children: randomTablesData.map((table, index) => {
                            const tableRows = table.map(row => {
                                return row.map(cell => new docx.TableCell({
                                    children: [new docx.Paragraph(cell)]
                                }));
                            });
                            return new docx.Table({
                                rows: tableRows,
                            });
                        })
                    }
                ]
            });
            docx.Packer.toBlob(doc).then(blob => {
                saveAs(blob, 'random_tables.docx');
            });
        }

        // Function to save secondary tables (for example in localStorage or backend)
        function saveSecondaryTables() {
            const primaryTableId = document.getElementById('primaryTableIdInput').value;
            localStorage.setItem(`secondaryTables_${primaryTableId}`, JSON.stringify(randomTablesData));
            alert('Secondary tables saved.');
        }

        // Function to retrieve secondary tables (for example from localStorage or backend)
        function retrieveSecondaryTables() {
            const primaryTableId = document.getElementById('primaryTableIdInput').value;
            const storedData = localStorage.getItem(`secondaryTables_${primaryTableId}`);
            if (storedData) {
                randomTablesData = JSON.parse(storedData);
                alert('Secondary tables retrieved.');
                const randomTablesContainer = document.getElementById('randomTablesContainer');
                randomTablesContainer.innerHTML = ''; // Clear previous tables
                randomTablesData.forEach(table => displayTable(table, randomTablesContainer));  // Display retrieved tables
            } else {
                alert('No stored data found for this Primary Table ID.');
            }
        }
    </script>
</body>
</html>
